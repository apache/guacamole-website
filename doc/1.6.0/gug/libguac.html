
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>libguac &#8212; Apache Guacamole Manual v1.6.0</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="_static/gug.css?v=475feb7f" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=c136e461"></script>
    <script src="_static/tabs.js?v=3ee01567"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'libguac';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="guacamole-common" href="guacamole-common.html" />
    <link rel="prev" title="The Guacamole protocol" href="guacamole-protocol.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Apache Guacamole Manual v1.6.0</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="guacamole-architecture.html">Implementation and architecture</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="installing-guacamole.html">Installing Guacamole</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="guacamole-native.html">Native installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="guacamole-docker.html">Containerized (Docker) installation</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="jdbc-auth.html">Database setup</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="mysql-auth.html">MariaDB / MySQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="postgresql-auth.html">PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="sqlserver-auth.html">SQL Server</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="security.html">Securing a Guacamole install</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="reverse-proxy.html">SSL termination</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth-ban.html">Blocking brute-force attacks</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Using Guacamole</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="configuring-guacamole.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-guacamole.html">General usage</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="administration.html">Administration</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="batch-import.html">Importing connections</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Extensions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ldap-auth.html">Active Directory / LDAP</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="mfa.html">Multi-factor authentication</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="duo-auth.html">Duo</a></li>
<li class="toctree-l2"><a class="reference internal" href="totp-auth.html">TOTP</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="sso.html">Single sign-on</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="cas-auth.html">CAS</a></li>
<li class="toctree-l2"><a class="reference internal" href="openid-auth.html">OpenID Connect</a></li>
<li class="toctree-l2"><a class="reference internal" href="saml-auth.html">SAML</a></li>
<li class="toctree-l2"><a class="reference internal" href="ssl-auth.html">Smart cards / Certificates</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="vault.html">Retrieving secrets from a vault</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="external-auth.html">External authentication</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="json-auth.html">Encrypted, signed JSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="header-auth.html">HTTP header</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="radius-auth.html">RADIUS</a></li>
<li class="toctree-l1"><a class="reference internal" href="adhoc-connections.html">Ad-hoc connections</a></li>
<li class="toctree-l1"><a class="reference internal" href="auth-restrict.html">Login / Connection restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="recording-playback.html">Session recording player</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer's Guide</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="guacamole-protocol.html">The Guacamole protocol</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">libguac</a></li>
<li class="toctree-l1"><a class="reference internal" href="guacamole-common.html">guacamole-common</a></li>
<li class="toctree-l1"><a class="reference internal" href="guacamole-common-js.html">guacamole-common-js</a></li>
<li class="toctree-l1"><a class="reference internal" href="guacamole-ext.html">guacamole-ext</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom-protocols.html">Adding new protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom-auth.html">Custom authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="event-listeners.html">Event listeners</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing-you-own-guacamole-app.html">Writing your own Guacamole application</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="protocol-reference.html">Guacamole protocol reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="jdbc-auth-schema.html">Database schema reference</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>libguac</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#error-handling">Error handling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#client-plugins">Client plugins</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entry-point">Entry point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#joining-leaving-a-connection">Joining/leaving a connection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#termination">Termination</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#layers-and-buffers">Layers and buffers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#streams">Streams</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-instructions">Sending instructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#event-handling">Event handling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-events">Key events</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mouse-events">Mouse events</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clipboard-file-and-other-stream-events">Clipboard, file, and other stream events</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="libguac">
<h1>libguac<a class="headerlink" href="#libguac" title="Link to this heading">#</a></h1>
<p>The C API for extending and developing with Guacamole is libguac. All native
components produced by the Guacamole project link with this library, and this
library provides the common basis for extending the native functionality of
those native components (by implementing client plugins).</p>
<p>libguac is used mainly for developing client plugins like libguac-client-vnc or
libguac-client-rdp, or for developing a proxy supporting the Guacamole protocol
like guacd. This chapter is intended to give an overview of how libguac is
used, and how to use it for general communication with the Guacamole protocol.</p>
<section id="error-handling">
<span id="libguac-error-handling"></span><h2>Error handling<a class="headerlink" href="#error-handling" title="Link to this heading">#</a></h2>
<p>Most functions within libguac handle errors by returning a zero or non-zero
value, whichever is appropriate for the function at hand. If an error is
encountered, the <code class="docutils literal notranslate"><span class="pre">guac_error</span></code> variable is set appropriately, and
<code class="docutils literal notranslate"><span class="pre">guac_error_message</span></code> contains a statically-allocated human-readable string
describing the context of the error. These variables intentionally mimic the
functionality provided by <code class="docutils literal notranslate"><span class="pre">errno</span></code> and <code class="docutils literal notranslate"><span class="pre">errno.h</span></code>.</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">guac_error</span></code> and <code class="docutils literal notranslate"><span class="pre">guac_error_message</span></code> are defined within <code class="docutils literal notranslate"><span class="pre">error.h</span></code>. A
human-readable string describing the error indicated by <code class="docutils literal notranslate"><span class="pre">guac_error</span></code> can be
retrieved using <code class="docutils literal notranslate"><span class="pre">guac_status_string()</span></code>, which is also statically allocated.</p>
<p>If functions defined within client plugins set <code class="docutils literal notranslate"><span class="pre">guac_error</span></code> and
<code class="docutils literal notranslate"><span class="pre">guac_error_message</span></code> appropriately when errors are encountered, the messages
logged to syslog by guacd will be more meaningful for both users and
developers.</p>
</section>
<section id="client-plugins">
<span id="libguac-client-plugins"></span><h2>Client plugins<a class="headerlink" href="#client-plugins" title="Link to this heading">#</a></h2>
<p>Client plugins are libraries which follow specific conventions such that they
can be loaded dynamically by guacd. All client plugins <em>must</em>:</p>
<ol class="arabic simple">
<li><p>Follow a naming convention, where the name of the library is
<code class="samp docutils literal notranslate"><span class="pre">libguac-client-</span><em><span class="pre">PROTOCOL</span></em></code>. <em>This is necessary for guacd to locate
the library for a requested protocol.</em></p></li>
<li><p>Be linked against libguac, the library used by guacd to handle the Guacamole
protocol. The structures which are given to functions invoked by guacd are
defined by libguac, and are expected to be manipulated via the functions
provided by libguac or as otherwise documented within the structure itself.
<em>Communication between guacd and client plugins is only possible if they
share the same core structural and functional definitions provided by
libguac.</em></p></li>
<li><p>Implement the standard entry point for client plugins, <code class="docutils literal notranslate"><span class="pre">guac_client_init()</span></code>,
described in more detail below. It is this function which initializes the
structures provided by guacd such that users can join and interact with the
connection.</p></li>
</ol>
<section id="entry-point">
<span id="libguac-lifecycle-entry"></span><h3>Entry point<a class="headerlink" href="#entry-point" title="Link to this heading">#</a></h3>
<p>All client plugins must provide a function named <code class="docutils literal notranslate"><span class="pre">guac_client_init</span></code> which
accepts, as its sole argument, a pointer to a <code class="docutils literal notranslate"><span class="pre">guac_client</span></code> structure.  This
function is similar in principle to the main() function of a C program, and it
is the responsibility of this function to initialize the provided structure as
necessary to begin the actual remote desktop connection, allow users to
join/leave, etc.</p>
<p>The provided <code class="docutils literal notranslate"><span class="pre">guac_client</span></code> will already have been initialized with handlers for
logging, the broadcast socket, etc. The absolutely critical pieces which must
be provided by <code class="docutils literal notranslate"><span class="pre">guac_client_init</span></code> are:</p>
<ol class="arabic simple">
<li><p>A handler for users which join the connection (<code class="docutils literal notranslate"><span class="pre">join_handler</span></code>). The join
handler is also usually the most appropriate place for the actual remote
desktop connection to be established.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">NULL</span></code>-terminated set of argument names which the client plugin accepts,
assigned to the args property of the given <code class="docutils literal notranslate"><span class="pre">guac_client</span></code>.  As the handshake
procedure is completed for each connecting user, these argument names will
be presented as part of the handshake, and the values for those arguments
will be passed to the join handler once the handshake completes.</p></li>
<li><p>A handler for users leaving the connection (<code class="docutils literal notranslate"><span class="pre">leave_handler</span></code>), if any
cleanup, updates, etc. are required.</p></li>
<li><p>A handler for freeing the data associated with the <code class="docutils literal notranslate"><span class="pre">guac_client</span></code> after the
connection has terminated (<code class="docutils literal notranslate"><span class="pre">free_handler</span></code>). If your plugin will allocate any
data at all, implementing the free handler is necessary to avoid memory leaks.</p></li>
</ol>
<p>If <code class="docutils literal notranslate"><span class="pre">guac_client_init</span></code> returns successfully, guacd will proceed with allowing
the first use to join the connection, and the rest of the plugin lifecycle
commences.</p>
</section>
<section id="joining-leaving-a-connection">
<span id="libguac-lifecycle-users"></span><h3>Joining/leaving a connection<a class="headerlink" href="#joining-leaving-a-connection" title="Link to this heading">#</a></h3>
<p>Whenever a user joins a connection, including the very first user of a
connection (the user which is establishing the remote desktop connection in the
first place), the join handler of the <code class="docutils literal notranslate"><span class="pre">guac_client</span></code> will be invoked. This
handler is provided with the <code class="docutils literal notranslate"><span class="pre">guac_user</span></code> structure representing the user that
just joined, along with the arguments provided during the handshake procedure:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">join_handler</span><span class="p">(</span><span class="n">guac_user</span><span class="o">*</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Synchronize display state, init the user, etc. */</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="cm">/* Within guac_client_init  */</span>
<span class="n">client</span><span class="o">-&gt;</span><span class="n">join_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">join_handler</span><span class="p">;</span>
</pre></div>
</div>
<p>As the parameters and user information provided during the Guacamole protocol
handshake are often required to be known before the remote desktop connection
can be established, the join handler is usually the best place to create a
thread which establishes the remote desktop connection and updates the display
accordingly.</p>
<p>If necessary, the user which first established the connection can be
distinguished from all other users by the owner flag of <code class="docutils literal notranslate"><span class="pre">guac_user</span></code>, which will
be set to a non-zero value.</p>
<p>Once a user has disconnected, the leave handler of <code class="docutils literal notranslate"><span class="pre">guac_client</span></code> will be
invoked. Just as with the join handler, this handler is provided the
<code class="docutils literal notranslate"><span class="pre">guac_user</span></code> structure of the user that disconnected. The <code class="docutils literal notranslate"><span class="pre">guac_user</span></code> structure
will be freed immediately after the handler completes:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">leave_handler</span><span class="p">(</span><span class="n">guac_user</span><span class="o">*</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Free user-specific data and clean up */</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="cm">/* Within guac_client_init  */</span>
<span class="n">client</span><span class="o">-&gt;</span><span class="n">leave_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leave_handler</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="termination">
<span id="libguac-lifecycle-termination"></span><h3>Termination<a class="headerlink" href="#termination" title="Link to this heading">#</a></h3>
<p>Once the last user of a connection has left, guacd will begin freeing resources
allocated to that connection, invoking the free handler of the <code class="docutils literal notranslate"><span class="pre">guac_client</span></code>.
At this point, the “leave” handler has been invoked for all previous users. All
that remains is for the client plugin to free any remaining data that it
allocated, such that guacd can clean up the rest:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">free_handler</span><span class="p">(</span><span class="n">guac_client</span><span class="o">*</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Disconnect, free client-specific data, etc. */</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="cm">/* Within guac_client_init  */</span>
<span class="n">client</span><span class="o">-&gt;</span><span class="n">free_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_handler</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="layers-and-buffers">
<span id="libguac-layers"></span><h2>Layers and buffers<a class="headerlink" href="#layers-and-buffers" title="Link to this heading">#</a></h2>
<p>The main operand of all drawing instructions is the layer, represented within
libguac by the <code class="docutils literal notranslate"><span class="pre">guac_layer</span></code> structure. Each <code class="docutils literal notranslate"><span class="pre">guac_layer</span></code> is normally allocated
using <code class="docutils literal notranslate"><span class="pre">guac_client_alloc_layer()</span></code> or <code class="docutils literal notranslate"><span class="pre">guac_client_alloc_buffer()</span></code>, depending on
whether a layer or buffer is desired, and freed with <code class="docutils literal notranslate"><span class="pre">guac_client_free_layer()</span></code>
or <code class="docutils literal notranslate"><span class="pre">guac_client_free_buffer()</span></code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Care must be taken to invoke the allocate and free pairs of each type of layer
correctly. <code class="docutils literal notranslate"><span class="pre">guac_client_free_layer()</span></code> should only be used to free layers
allocated with <code class="docutils literal notranslate"><span class="pre">guac_client_alloc_layer()</span></code>, and <code class="docutils literal notranslate"><span class="pre">guac_client_free_buffer()</span></code>
should only be used to free layers allocated with <code class="docutils literal notranslate"><span class="pre">guac_client_alloc_buffer()</span></code>,
all called using the same instance of <code class="docutils literal notranslate"><span class="pre">guac_client</span></code>.</p>
<p>If these restrictions are not observed, the effect of invoking these functions
is undefined.</p>
</div>
<p>Using these layer management functions allows you to reuse existing layers or
buffers after their original purpose has expired, thus conserving resources on
the client side, as allocation of new layers within the remote client is a
relatively expensive operation.</p>
<p>It is through layers and buffers that Guacamole provides support for
hardware-accelerated compositing and cached updates. Creative use of layers and
buffers leads to efficient updates on the client side, which usually translates
into speed and responsiveness.</p>
<p>Regardless of whether you allocate new layers or buffers, there is always one
layer guaranteed to be present: the default layer, represented by libguac as
<code class="docutils literal notranslate"><span class="pre">GUAC_DEFAULT_LAYER</span></code>. If you only wish to affect the main display of the
connected client somehow, this is the layer you want to use as the operand of
your drawing instruction.</p>
</section>
<section id="streams">
<span id="libguac-streams"></span><h2>Streams<a class="headerlink" href="#streams" title="Link to this heading">#</a></h2>
<p>In addition to drawing, the Guacamole protocol supports streaming of arbitrary
data. The main operand of all streaming instructions is the stream, represented
within libguac by the <code class="docutils literal notranslate"><span class="pre">guac_stream</span></code> structure.  Each <code class="docutils literal notranslate"><span class="pre">guac_stream</span></code> exists
either at the user or client levels, depending on whether the stream is
intended to be broadcast to all users or just one, and is thus allocated using
either <code class="docutils literal notranslate"><span class="pre">guac_client_alloc_stream()</span></code> or <code class="docutils literal notranslate"><span class="pre">guac_user_alloc_stream()</span></code>.
Explicitly-allocated streams must eventually be freed with
<code class="docutils literal notranslate"><span class="pre">guac_client_free_stream()</span></code> or <code class="docutils literal notranslate"><span class="pre">guac_user_free_stream()</span></code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Just as with layers, care must be taken to invoke the allocate and free pairs
correctly for each explicitly-allocated stream.  <code class="docutils literal notranslate"><span class="pre">guac_client_free_stream()</span></code>
should only be used to free streams allocated with
<code class="docutils literal notranslate"><span class="pre">guac_client_alloc_stream()</span></code>, and <code class="docutils literal notranslate"><span class="pre">guac_user_free_stream()</span></code> should only be used
to free streams allocated with <code class="docutils literal notranslate"><span class="pre">guac_user_alloc_stream()</span></code>.</p>
<p>If these restrictions are not observed, the effect of invoking these functions
is undefined.</p>
</div>
<p>Streams are the means by which data is transmitted for clipboard (via the
<a class="reference internal" href="protocol-reference.html#clipboard-instruction" title="clipboard"><span class="xref myst guac guac-instruction">“clipboard” instruction</span></a>), audio (via the <a class="reference internal" href="protocol-reference.html#audio-instruction" title="audio"><span class="xref myst guac guac-instruction">“audio”
instruction</span></a>), and even the images which make up typical
drawing operations (via the <a class="reference internal" href="protocol-reference.html#img-instruction" title="img"><span class="xref myst guac guac-instruction">“img” instruction</span></a>). They will
either be allocated for you, when an inbound stream is received from a user, or
allocated manually, when an outbound stream needs to be sent to a user. As with
<code class="docutils literal notranslate"><span class="pre">guac_client</span></code> and <code class="docutils literal notranslate"><span class="pre">guac_user</span></code>, each <code class="docutils literal notranslate"><span class="pre">guac_stream</span></code> has a set of handlers which
correspond to instructions received related to streams.  These instructions are
documented in more detail in <a class="reference internal" href="guacamole-protocol.html#guacamole-protocol-streaming"><span class="std std-ref">Streams and objects</span></a> and
<a class="reference internal" href="protocol-reference.html"><span class="doc std std-doc">Guacamole protocol reference</span></a>.</p>
</section>
<section id="sending-instructions">
<span id="libguac-sending-instructions"></span><h2>Sending instructions<a class="headerlink" href="#sending-instructions" title="Link to this heading">#</a></h2>
<p>All drawing in Guacamole is accomplished through the sending of instructions to
the connected client using the Guacamole protocol. The same goes for streaming
audio, video, or file content. All features and content supported by Guacamole
ultimately reduce to one or more instructions which are part of the documented
protocol.</p>
<p>Most drawing using libguac is done using Cairo functions on a <code class="docutils literal notranslate"><span class="pre">cairo_surface_t</span></code>
(see the Cairo API documentation) which is later streamed to the client using
an img instruction and subsequent blob instructions, sent via
<code class="docutils literal notranslate"><span class="pre">guac_client_stream_png()</span></code>. Cairo was chosen as a dependency of libguac to
provide developers an existing and stable means of drawing to image buffers
which will ultimately be sent as easy-to-digest PNG images.</p>
<p>The Guacamole protocol also supports drawing primitives similar to those
present in the Cairo API and HTML5’s canvas tag. These instructions are
documented individually in the Guacamole Protocol Reference in a section
dedicated to drawing instructions, and like all Guacamole protocol
instructions, each instruction has a corresponding function in libguac
following the naming convention <code class="samp docutils literal notranslate"><span class="pre">guac_protocol_send_</span><em><span class="pre">OPCODE</span></em><span class="pre">()</span></code>.</p>
<p>Each protocol function takes a <code class="docutils literal notranslate"><span class="pre">guac_socket</span></code> as an argument, which is the
buffered I/O object used by libguac. For each active connection, there are two
important types of <code class="docutils literal notranslate"><span class="pre">guac_socket</span></code> instance: the broadcast socket, which exists
at the client level within the <code class="docutils literal notranslate"><span class="pre">guac_client</span></code>, and the per-user socket, which is
accessible within each <code class="docutils literal notranslate"><span class="pre">guac_user</span></code>. Data sent along the client-level broadcast
socket will be sent to all connected users beneath that <code class="docutils literal notranslate"><span class="pre">guac_client</span></code>, while
data sent along a user-level socket will be sent only to that user.</p>
<p>For example, to send a “size” instruction to all connected users via the
client-level broadcast socket, you could invoke:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">guac_protocol_send_size</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">GUAC_DEFAULT_LAYER</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">);</span>
</pre></div>
</div>
<p>Or, if the instruction is only relevant to a particular user, the socket
associated with that user can be used instead:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">guac_protocol_send_size</span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">GUAC_DEFAULT_LAYER</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">768</span><span class="p">);</span>
</pre></div>
</div>
<p>The sockets provided by libguac are threadsafe at the protocol level.
Instructions written to a socket by multiple threads are guaranteed to be
written atomically with respect to that socket.</p>
</section>
<section id="event-handling">
<span id="libguac-event-handling"></span><h2>Event handling<a class="headerlink" href="#event-handling" title="Link to this heading">#</a></h2>
<p>Generally, as guacd receives instructions from the connected client, it invokes
event handlers if set within the associated <code class="docutils literal notranslate"><span class="pre">guac_user</span></code> or <code class="docutils literal notranslate"><span class="pre">guac_client</span></code>,
depending on the nature of the event. Most events are user-specific, and thus
the event handlers reside within the <code class="docutils literal notranslate"><span class="pre">guac_user</span></code> structure, but there are
client-specific events as well, such as a user joining or leaving the current
connection. Event handlers typically correspond to Guacamole protocol
instructions received over the socket by a connected user, which in turn
correspond to events which occur on the client side.</p>
<section id="key-events">
<span id="libguac-key-events"></span><h3>Key events<a class="headerlink" href="#key-events" title="Link to this heading">#</a></h3>
<p>When keys are pressed or released on the client side, the client sends key
instructions to the server. These instructions are parsed and handled by
calling the key event handler installed in the <code class="docutils literal notranslate"><span class="pre">key_handler</span></code> member of the
<code class="docutils literal notranslate"><span class="pre">guac_user</span></code>. This key handler is given the keysym of the key that was changed,
and a boolean value indicating whether the key was pressed or released.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">key_handler</span><span class="p">(</span><span class="n">guac_user</span><span class="o">*</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">keysym</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pressed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="cm">/* Within the &quot;join&quot; handler of guac_client */</span>
<span class="n">user</span><span class="o">-&gt;</span><span class="n">key_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key_handler</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="mouse-events">
<span id="libguac-mouse-events"></span><h3>Mouse events<a class="headerlink" href="#mouse-events" title="Link to this heading">#</a></h3>
<p>When the mouse is moved, and buttons are pressed or released, the client sends
mouse instructions to the server. These instructions are parsed and handled by
calling the mouse event handler installed in the <code class="docutils literal notranslate"><span class="pre">mouse_handler</span></code> member of the
<code class="docutils literal notranslate"><span class="pre">guac_user</span></code>. This mouse handler is given the current X and Y coordinates of the
mouse pointer, as well as a mask indicating which buttons are pressed and which
are released.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">mouse_handler</span><span class="p">(</span><span class="n">guac_user</span><span class="o">*</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">button_mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="cm">/* Within the &quot;join&quot; handler of guac_client */</span>
<span class="n">user</span><span class="o">-&gt;</span><span class="n">mouse_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_handler</span><span class="p">;</span>
</pre></div>
</div>
<p>The file <code class="docutils literal notranslate"><span class="pre">client.h</span></code> also defines the mask of each button for convenience:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">GUAC_CLIENT_MOUSE_LEFT</span></code></dt><dd><p>The left mouse button, set when pressed.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">GUAC_CLIENT_MOUSE_MIDDLE</span></code></dt><dd><p>The middle mouse button, set when pressed.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">GUAC_CLIENT_MOUSE_RIGHT</span></code></dt><dd><p>The right mouse button, set when pressed.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">GUAC_CLIENT_MOUSE_UP</span></code></dt><dd><p>The button corresponding to one scroll in the upwards direction of the mouse
scroll wheel, set when scrolled.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">GUAC_CLIENT_MOUSE_DOWN</span></code></dt><dd><p>The button corresponding to one scroll in the downwards direction of the
mouse scroll wheel, set when scrolled.</p>
</dd>
</dl>
</section>
<section id="clipboard-file-and-other-stream-events">
<span id="libguac-clipboard-events"></span><h3>Clipboard, file, and other stream events<a class="headerlink" href="#clipboard-file-and-other-stream-events" title="Link to this heading">#</a></h3>
<p>If a connected user sends data which should be sent to the clipboard of the
remote desktop, guacd will trigger the clipboard handler installed in the
<code class="docutils literal notranslate"><span class="pre">clipboard_handler</span></code> member of the <code class="docutils literal notranslate"><span class="pre">guac_user</span></code> associated with that user.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">clipboard_handler</span><span class="p">(</span><span class="n">guac_user</span><span class="o">*</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">guac_stream</span><span class="o">*</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">mimetype</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="cm">/* Within the &quot;join&quot; handler of guac_client */</span>
<span class="n">user</span><span class="o">-&gt;</span><span class="n">clipboard_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clipboard_handler</span><span class="p">;</span>
</pre></div>
</div>
<p>The handler is expected to assign further handlers to the provided
<code class="docutils literal notranslate"><span class="pre">guac_stream</span></code> as necessary, such that the <a class="reference internal" href="protocol-reference.html#blob-instruction" title="blob"><span class="xref myst guac guac-instruction">“blob”</span></a> and
<a class="reference internal" href="protocol-reference.html#end-instruction" title="end"><span class="xref myst guac guac-instruction">“end”</span></a> instructions received along the stream can be handled.
A similar handler is provided for received files:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">file_handler</span><span class="p">(</span><span class="n">guac_user</span><span class="o">*</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">guac_stream</span><span class="o">*</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span>
<span class="w">        </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">mimetype</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="cm">/* Within the &quot;join&quot; handler of guac_client */</span>
<span class="n">user</span><span class="o">-&gt;</span><span class="n">file_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_handler</span><span class="p">;</span>
</pre></div>
</div>
<p>This pattern continues for all other types of streams which can be received
from a user. The instruction which begins the stream has a corresponding
handler within <code class="docutils literal notranslate"><span class="pre">guac_user</span></code>, and the metadata describing that stream and
provided with the instruction is included within the parameters passed to that
handler.</p>
<p>These handlers are, of course, optional. If any type of stream lacks a
corresponding handler, guacd will automatically close the stream and respond
with an <a class="reference internal" href="protocol-reference.html#ack-instruction" title="ack"><span class="xref myst guac guac-instruction">“ack” instruction</span></a> and appropriate error code,
informing the user’s Guacamole client that the stream is unsupported.</p>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="guacamole-protocol.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The Guacamole protocol</p>
      </div>
    </a>
    <a class="right-next"
       href="guacamole-common.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">guacamole-common</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#error-handling">Error handling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#client-plugins">Client plugins</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entry-point">Entry point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#joining-leaving-a-connection">Joining/leaving a connection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#termination">Termination</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#layers-and-buffers">Layers and buffers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#streams">Streams</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-instructions">Sending instructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#event-handling">Event handling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-events">Key events</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mouse-events">Mouse events</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clipboard-file-and-other-stream-events">Clipboard, file, and other stream events</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Apache Software Foundation
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025 The Apache Software Foundation.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>